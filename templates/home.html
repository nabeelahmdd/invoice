{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1 class="mt-5 mb-4 text-center">Hello, {{request.user.email}}!</h1>
    {% if request.user.is_authenticated %}
        <p class="text-center mb-4">Last login: {{ user.last_login|date:"D, d M Y H:i:s" }}</p>
    {% endif %}

    <div class="row mb-4">
        <div class="col-md-3">
            <select id="page-length" class="form-control">
                <option value="10">10 rows</option>
                <option value="25">25 rows</option>
                <option value="50">50 rows</option>
                <option value="100">100 rows</option>
            </select>
        </div>
        <div class="col-md-6">
            <div class="input-group">
                <input type="text" id="custom-search" class="form-control" placeholder="Search...">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button">
                        <i class="fa fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <a class="btn btn-primary" href="{% url 'invoice-create' %}">
                <i class="fa fa-plus"></i> Add New Invoice
            </a>
        </div>
    </div>

    <div class="table-responsive">
        <table id="book-table" class="table table-striped table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th scope="col" id="name">Name</th>
                    <th scope="col" id="mobile">Mobile</th>
                    <th scope="col" id="address">Address</th>
                    <th scope="col" id="total">Total</th>
                    <th scope="col" id="preview">View</th>
                    <th scope="col" id="Action">Action</th>
                </tr>
            </thead>
        </table>
    </div>

    <nav aria-label="Table navigation" class="mt-4">
        <ul class="pagination justify-content-center" id="table-pagination">
            <!-- Pagination will be populated by DataTables -->
        </ul>
    </nav>
</div>
{% endblock content %}

{% block javascript %}
<script>
    $(document).ready(function() {
        var table = $('#book-table').DataTable({
            serverSide: true,
            processing: true,
            ajax: {
                url: "{% url 'invoice-list' %}",
                type: "POST",
                data: function(d) {
                    d.csrfmiddlewaretoken = '{{ csrf_token }}';
                    d.custom_search = $('#custom-search').val();  // Add this line
                    return d;
                }
            },
            columns: [
                { data: 'name' },
                { data: 'mobile' },
                { data: 'address' },
                { data: 'total' },
                { 
                    data: 'id',
                    render: function(data) {
                        return `<a href="/invoice/detail/${data}/" target="_blank" class="btn btn-sm btn-info">
                                    <i class="fa fa-eye"></i>
                                </a>`;
                    }
                },
                { 
                    data: 'id',
                    render: function(data) {
                        return `<a href="/invoice/edit/${data}/" class="btn btn-sm btn-warning mr-2">
                                    <i class="fa fa-edit"></i>
                                </a>
                                <a href="#" class="btn btn-sm btn-danger delete-modal" url="/invoice/delete/${data}/">
                                    <i class="fa fa-trash"></i>
                                </a>`;
                    }
                },
            ],
            dom: 'lrtip',
            lengthChange: false,
            pageLength: 10,
            pagingType: "simple_numbers",
            language: {
                paginate: {
                    previous: '&laquo;',
                    next: '&raquo;'
                }
            },
            drawCallback: function(settings) {
                var pagination = $(this).closest('.dataTables_wrapper').find('.dataTables_paginate');
                pagination.toggle(this.api().page.info().pages > 1);
                
                $('#table-pagination').html(pagination.find('ul.pagination').html());
            }
        });

        // Custom search functionality
        $('#custom-search').on('keyup', function(){
            table.ajax.reload();
        });
        // Page length change functionality
        $('#page-length').on('change', function(){
            table.page.len($(this).val()).draw();
        });
    });
</script>
{% endblock %}